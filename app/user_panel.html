<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="author" content="https://github.com/aaa/">
    <title>덴탈플러스</title>
    <link href="css/fontawesome/css/fontawesome-all.css" rel="stylesheet"> <!-- font awesome 5.* pro -->
	<link rel="stylesheet" href="css/dentalBasic.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.3.5/cropper.css">

	<script src="js/jquery-1.12.4.min.js"></script>
    <script src="js/common.js"></script>
	<script src="js/handlebars.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.3.5/cropper.js"></script>
	<style>
		.cropper-view-box { border-radius: 50%; }
		.dental-cropper-preview { border-radius: 50%; }
		/* .cropper-dashed { border: 0 dashed #FFF; } */
		.cropper-dashed.dashed-v { border-left-width: 2px; border-right-width: 2px; }
		.cropper-dashed.dashed-h { border-top-width: 2px; border-bottom-width: 2px; }
		/* .cropper-center:before,
		.cropper-center:after  { background-color: #FFF; } */
		.dental-cropper-preview-container { min-height: 100px; }
		.dental-cropper-preview { width: 100px; height: 100px; }
	</style>
</head>
<body>
    <header class="register-header navbar">
        <section class="navbar-section">
            <span onclick="if(history.length>2){ history.back(); } else { location.href='liveboard.html'; }">
                <i class="fal fa-arrow-square-left"></i>
                이전페이지
            </span>
        </section>
        <section class="navbar-section">
            <a href="liveboard.html"><i class="fal fa-home"></i></a>
            <a href="user_panel.html"><i class="fal fa-user-alt"></i></a>
        </section>
    </header>
    <section class="user-panel-section dental-panel">
		<div class="dental-panel-header">
			<div class="user-photo" id="userProfile">
				<div class="user-photo-box">
					<div class="image-frame"><img id="userPic"></div>
					<span class="user-photo-box-icon" id="userProfileArea"><i class="camera-icon"></i></span>
				</div>
				<input type="file" id="uploadUserProfile" accept="image/*" hidden>
				<div class="user-photo-title" id="userEmail"></div>
				<div class="user-photo-subtitle" id="userName"></div>
			</div>
			<div class="dental-panel-opt"><a href="user_setting.html"><i class="fas fa-cog"></i></a></div>
		</div>
		<div class="panel-nav">
			<nav class="dental-icon-nav">
				<a class="icon-nav-item" href="register_user.html">
					<span class="nav-item-icon"><i class="fal fa-thumbtack"></i></span>
					<span class="nav-item-title">관심지역</span>
				</a>
				<a class="icon-nav-item" href="register_user.html">
					<span class="nav-item-icon"><i class="fal fa-home"></i></span>
					<span class="nav-item-title">우리동네</span>
				</a>
				<a class="icon-nav-item" href="user_interaction.html">
					<span class="nav-item-icon"><i class="fal fa-heart"></i></span>
					<span class="nav-item-title">관심병원</span>
				</a>
				<a class="icon-nav-item" href="user_interaction.html">
					<span class="nav-item-icon"><i class="fal fa-star"></i></span>
					<span class="nav-item-title">내스크랩</span>
				</a>
				<a class="icon-nav-item" href="user_interaction.html">
					<span class="nav-item-icon"><i class="fal fa-envelope-open"></i></span>
					<span class="nav-item-title">지원현황</span>
				</a>
				<a class="icon-nav-item" href="user_interaction.html">
					<span class="nav-item-icon"><i class="fal fa-calendar-exclamation"></i></span>
					<span class="nav-item-title">면접요청</span>
				</a>
				<a class="icon-nav-item" href="resume.html">
					<span class="nav-item-icon"><i class="fal fa-file-alt"></i></span>
					<span class="nav-item-title">이력서열람</span>
				</a>
				<a class="icon-nav-item" href="register_resume.html">
					<span class="nav-item-icon"><i class="fal fa-file-edit"></i></span>
					<span class="nav-item-title">이력서수정</span>
				</a>
				<a class="icon-nav-item" href="modify_password.html">
					<span class="nav-item-icon"><i class="fal fa-key"></i></span>
					<span class="nav-item-title">비밀번호</span> 
				</a>
				<!-- 비밀번호 변경 또는 찾기 비밀번호와 알림설정 그리고 아래 로그아웃은 한 페이지로 작성, 메뉴는 네비게이션으로 제공-->
				<a class="icon-nav-item" href="user_setting.html">
					<span class="nav-item-icon"><i class="fal fa-bell"></i></span>
					<span class="nav-item-title">알림설정</span> <!-- 메시지 수신 동의 설정-->
				</a>
				<a class="icon-nav-item" href="javaScript:void(0)" onclick="dModal.toast(' 1.카톡플러스친구 연동 2.메일보내기 등으로 검토 ');">
					<span class="nav-item-icon"><i class="fal fa-question-square"></i></span>
					<span class="nav-item-title">고객센터</span> <!-- 카카오톡 플러스 친구 또는 메일 보내기 // 전화는 일단 X-->
				</a>
				<a class="icon-nav-item" href="dentalplus_inform.html">
					<span class="nav-item-icon"><i class="fal fa-info-circle"></i></span>
					<span class="nav-item-title">공지/안내</span> <!-- 공지/안내 -->
				</a>
			</nav>
		</div>
		<div class="panel-body"></div>
		<div class="panel-footer">
			<a class="btn btn-sm" href="javaScript:void(0);" onclick="LOGIN_INFO.logout();"> <span>로그 아웃</span> </a>
		</div>
	</section>
	<section class="dental-cropper" id="dentalCropper">
		<div class="dental-cropper-header">
			<div class="typo-title">영역 선택해서 등록하기</div>
			<button class="d-icon d-close" id="clearBtn"></button>
		</div>
		<div class="dental-cropper-body">
			<div style="margin-left: 5%;">미리보기</div>
			<div style="margin-left: 5%; font-size: 0.5rem; color: #5d5d5d;">원하는 영역을 적절하게 선택해 주세요</div>
			<div class="dental-cropper-preview-container">
				<div class="dental-cropper-preview" id="cropImagePreview"></div>
				<button id="cropBtn" class="btn d-icon d-upload"></button>
				<button id="resetBtn" class="btn d-icon d-refresh"></button>
				<button id="getBtn" class="btn btn-action">GET!</button>
			</div>
			<div class="dental-cropper-img"><img src="" class="target_img" id="cropTarget"></div>
		</div>
	</section>
<script src="js/dental_ui.js"></script>
<script>



var UserPanelApp = (function() {

	var CROPPER;
	if ( !LOGIN_INFO.checkAuthPersonal() ) return;


	callApi("GET", "/api/user/"+LOGIN_INFO.getId()+"/basicInfo/", null,
		function(resData) {			
			document.getElementById("userEmail").innerText = resData.email;
			document.getElementById("userName").innerText  = resData.name;
			//if ( resData.hasProfileImage ) document.getElementById("userPic").src = CONSTANTS.getProfileImageUrl(resData.userId);
			if ( resData.profileImageUrl ) document.getElementById("userPic").src = resData.profileImageUrl;
		},
		function(errorCode, errorMsg) {
			alert("에러 [" + errorCode + "] ==> [" + errorMsg + "]");
		}
	);

	document.getElementById("uploadUserProfile").addEventListener("change", function(e) {

		console.log(e.target.files[0]);
		var cropTarget = document.getElementById("cropTarget");
		cropTarget.src = window.URL.createObjectURL(this.files[0]);

		if ( CROPPER ) {
			console.log( cropTarget.src);
			console.log("replace");
			CROPPER.replace(cropTarget.src);
			dentalCropper.classList.toggle("active");
		} else {
			console.log("new CROPPER");
			CROPPER = new Cropper ( cropTarget, {
				aspectRatio : 1 / 1,
				movable : false,
				preview : document.getElementById("cropImagePreview"),
				minCropBoxWidth : 20
			});

			dentalCropper.classList.toggle("active");

		}
		console.log(CROPPER);
	});

	$("#cropBtn").on("click", function(e) {

		if( !CROPPER ) return dModal.instant("카메라 아이콘을 먼저 선택해주세요.");

		var cropElm = CROPPER.getCroppedCanvas();
		// var cropped = cropElm.toDataURL("image/jpeg", 1.0);

		cropElm.toBlob(function (blob) {
			console.log(blob);
			var url = window.URL.createObjectURL(blob);
			// blob.lastModifiedDate = new Date();
			// blob.name = "profile";

			var formData = new FormData();
			formData.append("file", blob);

			userId= LOGIN_INFO.isPersonalMember() ? LOGIN_INFO.getId() : "";

			uploadFile("/api/user/"+userId+"/pic/", formData,
				function(resData) {
					dModal.instant("프로필이 등록되었습니다.");
					console.log("파일 업로드 성공 : ", resData);
					dentalCropper.classList.toggle("active");
					// document.getElementById("hospitalLogo").src = CONSTANTS.getHospitalLogoImageUrl(LOGIN_INFO.getHospitalId()) + "?" + (Math.random()*1000);
					if ( resData ) document.getElementById("userPic").src = resData + "?" + (Math.random()*1000);
				},
				function(errorCode, errorMsg) {
					dModal.alert("병원 로고 이미지 등록에 실패했습니다. [" + errorCode + "]");
					dentalCropper.classList.toggle("active");
				}
			);

			userPic.onload = function(event) {
				URL.revokeObjectURL(url);
			};

			userPic.src = url;
		}, 'image/jpeg');

	});

	$("#resetBtn").on("click", function(e) {
		if( !CROPPER ) return dModal.instant("카메라 아이콘을 먼저 선택해주세요.");
		CROPPER.reset();
	});

	$("#clearBtn").on("click", function(e) {
		if( !CROPPER ) return dModal.instant("카메라 아이콘을 먼저 선택해주세요.");
		CROPPER.destroy();
		cropTarget.src = "";
		CROPPER = "";
		dentalCropper.classList.remove("active");
		// uploadHospitalLogo.value= "";
	});

	$("#getBtn").on("click", function(e) {
		if( !CROPPER ) return dModal.instant("카메라 아이콘을 먼저 선택해주세요.");
		var d = CROPPER.getImageData();
		console.log(d);
		dModal.alert(
		"naturalHeight: " + d.naturalHeight 
		+ "\nnaturalWidth: " + d.naturalWidth
		+ "\nheight: " + d.height
		+ "\naspectRatio: " + d.aspectRatio
		+ "\nrotate: " + d.rotate
		);
	});

	document.getElementById("userProfileArea").addEventListener("click", function(e) {
		uploadUserProfile.value= "";
		document.getElementById("uploadUserProfile").click();
	});


})();
</script>
</body>
</html>
