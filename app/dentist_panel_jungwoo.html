<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="author" content="https://github.com/aaa/">
    <title>덴탈플러스</title>
    <link href="css/fontawesome/css/fontawesome-all.css" rel="stylesheet"> <!-- font awesome 5.* pro -->
	  <link rel="stylesheet" href="css/dentalBasic.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.3.5/cropper.css">
    
	  <script src="js/jquery-1.12.4.min.js"></script>
    <script src="js/common.js"></script>
	  <script src="js/handlebars.min.js"></script>
    <script src="js/dental_ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.3.5/cropper.js"></script>
</head>
<body>
  <header class="register-header navbar">
      <section class="navbar-section">
          <span onclick="if(history.length>2){ history.back(); } else { location.href='liveboard.html'; }">
              <i class="fal fa-arrow-square-left"></i>
              이전페이지
          </span>
      </section>
      <section class="navbar-section">
          <a href="liveboard.html"><i class="fal fa-home"></i></a>
          <a href="dentist_panel.html"><i class="fal fa-user-alt"></i></a>
      </section>
  </header>
  <section class="dentist-panel-section dental-panel">
		<div class="dental-panel-header">
			<div class="user-photo">
				<div class="hospital-log-box">
					<div class="logo-frame-hospital">
						<img src="" id="hospitalLogo">
						<span class="user-photo-box-icon" id="hospitalLogoArea"><i class="camera-icon"></i></span>
					</div>
				</div>
				<input type="file" id="uploadHospitalLogo" accept="image/*" hidden>
				<div class="user-photo-title" id="hospitalEmail">sjw0927@ gmail.com</div>
				<div class="user-photo-subtitle" id="hospitalName">서울역 앞 치과 병원</div>
			</div>
			<div class="dental-panel-opt"><a href="user_setting.html"><i class="fas fa-cog"></i></a></div>
    </div>
    <div class="dental-cropper" id="dentalCropper">
        <style>
          .dental-cropper { display: none; position: fixed; transform: translateY( 500% ); transition: all 0.5s ease; background-color: #FFF; }
          .dental-cropper.active { display: block;  transform: translateY(0); top: 10%; bottom: 0; right: 0; left: 0; transition: all 0.5s ease; }
          .dental-cropper-btn-group { display: flex; flex-wrap: wrap; justify-content: space-between; }
          .dental-cropper-btn-group button { min-width: 5rem; margin-right: 0.2rem; }
        </style>
        <div style="width: 90%; margin: 0 auto; height: auto; max-height: 400px; background-color: #FAFAFA;">
            <img src="" class="target_img" id="cropTarget" style="max-width: 100%;">
        </div>
        <div class="dental-cropper-btn-group">
            <button id="cropBtn" class="btn btn-primary">Register!</button>
            <button id="resetBtn" class="btn btn-action">Reset!</button>
            <button id="clearBtn" class="btn btn-action">Clear!</button>
            <button id="getBtn" class="btn btn-action">GET!</button>
        </div>
    </div>

  </section>
</body>
<script>
  $(document).ready(function () {
    if ( LOGIN_INFO.checkAuthHospital(false) ) return dModal.toast(LOGIN_INFO.getEmail() + " 님 로그인 되었어요");
  });
  var CROPPER;

	document.getElementById("hospitalLogoArea").addEventListener("click", function(e) {
		document.getElementById("uploadHospitalLogo").click();
  });

  

  $("#uploadHospitalLogo").on("change", function(e) {
    console.log(e.target.files[0]);
    var cropTarget = document.getElementById("cropTarget");
    cropTarget.src = window.URL.createObjectURL(this.files[0]);
    if ( CROPPER ) {
      console.log( cropTarget.src);
      console.log("replace");
      CROPPER.replace(cropTarget.src);
      dentalCropper.classList.toggle("active");
    } else {
      console.log("newCROPPER");
      CROPPER = new Cropper ( cropTarget, {
        aspectRatio : 150 / 50
      });
      dentalCropper.classList.toggle("active");
    }
    console.log(CROPPER);
  });

  $("#cropBtn").on("click", function(e) {

    if( !CROPPER ) return dModal.instant("카메라 아이콘을 먼저 선택해주세요.");

    var cropElm = CROPPER.getCroppedCanvas();
    // var cropped = cropElm.toDataURL("image/jpeg", 1.0);
    
    cropElm.toBlob(function (blob) {
      console.log(blob);
      var url = window.URL.createObjectURL(blob);
      // blob.lastModifiedDate = new Date();
      // blob.name = "profile";

      var formData = new FormData();
      formData.append("file", blob);

      hospitalId= LOGIN_INFO.isHospitalMember() ? LOGIN_INFO.getHospitalId() : "";

      uploadFile("/api/hospital/"+hospitalId+"/logo/", formData,
			function(resData) {
        dModal.instant("병원 로고가 등록되었습니다.");
        console.log("파일 업로드 성공 : ", resData);
        dentalCropper.classList.toggle("active");
        //document.getElementById("hospitalLogo").src = CONSTANTS.getHospitalLogoImageUrl(LOGIN_INFO.getHospitalId()) + "?" + (Math.random()*1000);
        if ( resData ) document.getElementById("hospitalLogo").src = resData + "?" + (Math.random()*1000);
			},
			function(errorCode, errorMsg) {
        alert("병원 로고 이미지 등록에 실패했습니다. [" + errorCode + "]");
        dentalCropper.classList.toggle("active");
			}
		);

      hospitalLogo.onload = function(event) {
        URL.revokeObjectURL(url);
      };

      hospitalLogo.src = url;
    }, 'image/jpeg');
  
  });

  $("#resetBtn").on("click", function(e) {
    if( !CROPPER ) return dModal.instant("카메라 아이콘을 먼저 선택해주세요.");
    CROPPER.reset();
  });

  $("#clearBtn").on("click", function(e) {
    if( !CROPPER ) return dModal.instant("카메라 아이콘을 먼저 선택해주세요.");
    CROPPER.destroy();
    cropTarget.src = "";
    CROPPER = "";
  });

  $("#getBtn").on("click", function(e) {
    if( !CROPPER ) return dModal.instant("카메라 아이콘을 먼저 선택해주세요.");
    var d = CROPPER.getImageData();
    console.log(d);
    dModal.alert(
      "naturalHeight: " + d.naturalHeight 
      + "\nnaturalWidth: " + d.naturalWidth
      + "\nheight: " + d.height
      + "\naspectRatio: " + d.aspectRatio
      + "\nrotate: " + d.rotate
    );
  });

  function onChangeHospitalLogo(event) {
		event.preventDefault();

		// console.log("병원 ID : ", hospitalId);
    console.log(event);
    console.log(event.target.src);


		// if ( !hospitalId ) {
		// 	alert("로그인되어 있지 않습니다.");
		// 	return;
		// }

		// console.log("업로드 대상 : ", this.value);
		// var files = event.target.files;
		// var filesArr = Array.prototype.slice.call(files);

		// filesArr.forEach(function(file) {
		// 	if ( !file.type.match("image.*") ) {
		// 		alert("이미지 파일만 업로드 가능합니다.");
		// 		return;
		// 	}
		// 	console.log("업로드 대상 파일 확인 완료 : ", file);
		// 	console.log("AAA : ", file.name, "   ", file.type);
		// });


		// var file = files[0];    // 첫번째 파일만 처리
		// console.log("업로드할 파일 ", file);
		// var formData = new FormData();
		// formData.append("file", file);

		// uploadFile("/api/hospital/"+hospitalId+"/logo/", formData,
		// 	function(resData) {
		// 		console.log("파일 업로드 성공 : ", resData);
		// 		document.getElementById("hospitalLogo").src = CONSTANTS.getHospitalLogoImageUrl(LOGIN_INFO.getHospitalId()) + "?" + (Math.random()*1000);
		// 	},
		// 	function(errorCode, errorMsg) {
		// 		alert("병원 로고 이미지 등록에 실패했습니다. [" + errorCode + "]");
		// 	}
		// );

	}
</script>
</html>

<!-- <script>

	
var ResumeManagementApp = (function() {

	var hospitalId;

	function init() {

		if ( !LOGIN_INFO.checkAuthHospital(false) ) return;
		

		var userId = LOGIN_INFO.getId();
        callApi("GET", "/api/user/"+userId+"/hospital/basicInfo/", null,
            function(basicInfo) {
				console.log(basicInfo);

				if ( !basicInfo || !basicInfo.hospitalId ) {
					hospitalId = null;

					document.getElementById("hospitalEmail").innerText = "";
					document.getElementById("hospitalName").innerText  = "";
					document.getElementById("hospitalLogo").src = "";


					alert("병원정보가 등록되어 있지 않습니다. 먼저 병원 정보를 등록하여 주십시오.");
					return;
				}
				

				hospitalId = basicInfo.hospitalId;

                document.getElementById("hospitalEmail").innerText = basicInfo.hospitalEmail;
				document.getElementById("hospitalName").innerText  = basicInfo.hospitalName;
				if ( basicInfo.hasLogoImage ) document.getElementById("hospitalLogo").src = CONSTANTS.getHospitalLogoImageUrl(basicInfo.hospitalId);


            },
            function(errorCode, errorMsg) {
                alert("에러 [" + errorCode + "] ==> [" + errorMsg + "]");
            }
        );

	}

	init();



	function onChangeHospitalLogo(event) {
		event.preventDefault();

		console.log("병원 ID : ", hospitalId);

		if ( !hospitalId ) {
			alert("로그인되어 있지 않습니다.");
			return;
		}

		console.log("업로드 대상 : ", this.value);
		var files = event.target.files;
		var filesArr = Array.prototype.slice.call(files);

		filesArr.forEach(function(file) {
			if ( !file.type.match("image.*") ) {
				alert("이미지 파일만 업로드 가능합니다.");
				return;
			}
			console.log("업로드 대상 파일 확인 완료 : ", file);
			console.log("AAA : ", file.name, "   ", file.type);
		});


		var file = files[0];    // 첫번째 파일만 처리
		console.log("업로드할 파일 ", file);
		var formData = new FormData();
		formData.append("file", file);

		uploadFile("/api/hospital/"+hospitalId+"/logo/", formData,
			function(resData) {
				console.log("파일 업로드 성공 : ", resData);
				document.getElementById("hospitalLogo").src = CONSTANTS.getHospitalLogoImageUrl(LOGIN_INFO.getHospitalId()) + "?" + (Math.random()*1000);
			},
			function(errorCode, errorMsg) {
				alert("병원 로고 이미지 등록에 실패했습니다. [" + errorCode + "]");
			}
		);

	}

	document.getElementById("uploadHospitalLogo").addEventListener("change", onChangeHospitalLogo);
	document.getElementById("hospitalLogoArea").addEventListener("click", function(e) {
		document.getElementById("uploadHospitalLogo").click();
	});
})();
</script> -->
